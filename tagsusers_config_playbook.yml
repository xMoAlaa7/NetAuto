---
#If you're going to prepend any lines with no, uncomment vars and prepend_info

- hosts: all
  #vars:

    #prepend_info: Some
  gather_facts: false
  pre_tasks:
    - name: Confirmation #Skip this by using --skip-tags always or setting -e skip_confirmation=true
      tags: always
      vars:
        playbook_name: tagsusers_config_playbook.yml
        skip_confirmation: false
      include_role:
        name: confirmation
      when: skip_confirmation == false

    - name: Backup for Comparison (Before)
      tags: always
      vars:
        skip_compare: false #Skip this by using --skip-tags always or setting -e skip_compare=true
      cisco.ios.ios_config:
        backup: true
        backup_options:
          filename: "{{ inventory_hostname }}_cmp_before.cfg"
          dir_path: backup/compare_confs
      when: skip_compare == false

  tasks:
    - name: Configure users
      tags: users, d_users
      cisco.ios.ios_config:
        lines:
          - "{{ item.value.disabled }} {{ item.key }} priv {{ item.value.privilege }} secret {{ item.value.secret }} {{ item.value.hashed_password }}"
      loop: "{{ users | dict2items }}"
      register: users_conf

    - name: Configure SSH keys
      tags: users, d_users
      no_log: false
      cisco.ios.ios_user:
        aggregate:
          - name: "{{ item.key }}"
            sshkey: "{{ item.value.sshkey }}"
            state: "{{ item.value.state }}"  #This will remove the key when set to absent.
      loop: "{{ users | dict2items }}"
      register: ssh_conf

  post_tasks:
    - name: Compare with Previous Configuration #Skip this by using --skip-tags always or setting -e skip_compare=true
      tags: always
      vars:
        skip_compare: false
      when: skip_compare == false
      block:
        - name: Backup for Comparison (After)
          cisco.ios.ios_config:
            backup: true
            backup_options:
              filename: "{{ inventory_hostname }}_cmp_after.cfg"
              dir_path: backup/compare_confs
        - name: Compare with Previous Configuration
          cisco.ios.ios_config:
            running_config: "{{ lookup('file', 'backup/compare_confs/{{ inventory_hostname }}_cmp_before.cfg') }}"
            diff_against: intended
            intended_config: "{{ lookup('file', 'backup/compare_confs/{{ inventory_hostname }}_cmp_after.cfg') }}"
  
    - name: Debug
      tags: never, debug
      block:
        - name: Debug users
          tags: debug, d_users
          debug:
            var: users_conf

        - name: Debug ssh keys
          tags: debug, d_users
          debug:
            var: ssh_conf
